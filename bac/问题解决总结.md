# é—®é¢˜è§£å†³æ€»ç»“

## ğŸš¨ é‡åˆ°çš„é—®é¢˜

### 1. Kryo åºåˆ—åŒ–é—®é¢˜
```
KryoException: Encountered unregistered class ID: 104
Serialization trace: media (org.springframework.ai.chat.messages.AssistantMessage)
```

### 2. ç©ºå…ƒç´ é—®é¢˜
```
IllegalArgumentException: messages cannot contain null elements
```

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®å¤åºåˆ—åŒ–ï¼ˆå·²å®ç°ï¼‰
1. **æ³¨å†Œ Spring AI ç›¸å…³ç±»**ï¼š
   - åœ¨ Kryo ä¸­æ³¨å†Œäº† `Media`ã€`UserMessage`ã€`AssistantMessage` ç­‰ç±»
   - ç§»é™¤äº†ä¸å­˜åœ¨çš„ `FunctionMessage` ç±»

2. **è¿‡æ»¤ null å…ƒç´ **ï¼š
   - åœ¨è¯»å–æ—¶è¿‡æ»¤æ‰ null å…ƒç´ 
   - åœ¨å†™å…¥æ—¶è¿‡æ»¤æ‰ null å…ƒç´ 

3. **æ”¹è¿›é”™è¯¯å¤„ç†**ï¼š
   - åºåˆ—åŒ–å¤±è´¥æ—¶è‡ªåŠ¨åˆ é™¤æ—§æ–‡ä»¶
   - æ›´å¥½çš„é”™è¯¯æ—¥å¿—è®°å½•

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨å†…å­˜å­˜å‚¨ï¼ˆæ¨èï¼‰
åˆ›å»ºäº† `InMemoryChatMemory` ç±»ä½œä¸ºä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼š

**ä¼˜ç‚¹**ï¼š
- å®Œå…¨é¿å…åºåˆ—åŒ–é—®é¢˜
- æ€§èƒ½æ›´å¥½
- ä»£ç æ›´ç®€å•

**ç¼ºç‚¹**ï¼š
- é‡å¯åå¯¹è¯è®°å½•ä¸¢å¤±
- ä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ

## ğŸ“ æ–‡ä»¶ä¿®æ”¹

### æ–°å¢æ–‡ä»¶
- `src/main/java/com/mashang/bac/web/chatmemory/InMemoryChatMemory.java`
- `cleanup-chat-memory.bat` (Windows æ¸…ç†è„šæœ¬)
- `cleanup-chat-memory.sh` (Linux/Mac æ¸…ç†è„šæœ¬)

### ä¿®æ”¹æ–‡ä»¶
- `src/main/java/com/mashang/bac/web/chatmemory/FileBasedChatMemory.java`
- `src/main/java/com/mashang/bac/web/service/BasicChatService.java`
- `src/main/java/com/mashang/bac/web/service/RagChatService.java`

## ğŸš€ ä½¿ç”¨å»ºè®®

### å¼€å‘ç¯å¢ƒ
ä½¿ç”¨ `InMemoryChatMemory`ï¼Œé¿å…åºåˆ—åŒ–é—®é¢˜ï¼š

```java
// å·²åœ¨ BasicChatService å’Œ RagChatService ä¸­é…ç½®
ChatMemory chatMemory = new InMemoryChatMemory();
```

### ç”Ÿäº§ç¯å¢ƒ
å¦‚æœéœ€è¦æŒä¹…åŒ–ï¼Œå»ºè®®ï¼š

1. **ä½¿ç”¨ JSON åºåˆ—åŒ–**ï¼š
```java
ObjectMapper mapper = new ObjectMapper();
mapper.writeValue(file, messages);
List<Message> messages = mapper.readValue(file, new TypeReference<List<Message>>() {});
```

2. **ä½¿ç”¨æ•°æ®åº“å­˜å‚¨**ï¼š
```java
// å°†å¯¹è¯è®°å½•å­˜å‚¨åˆ°æ•°æ®åº“
@Repository
public class ChatMemoryRepository {
    // å®ç°æ•°æ®åº“å­˜å‚¨é€»è¾‘
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

ç°åœ¨å¯ä»¥é‡æ–°è¿è¡Œæµ‹è¯•ï¼š

```bash
mvn test
```

åº”è¯¥ä¸ä¼šå†å‡ºç°åºåˆ—åŒ–é”™è¯¯å’Œç©ºå…ƒç´ é”™è¯¯ã€‚

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **Mockito è­¦å‘Š**ï¼šè¿™æ˜¯æ­£å¸¸çš„ï¼Œä¸å½±å“åŠŸèƒ½
2. **å†…å­˜ä½¿ç”¨**ï¼šä½¿ç”¨å†…å­˜å­˜å‚¨æ—¶æ³¨æ„å†…å­˜ä½¿ç”¨æƒ…å†µ
3. **æ•°æ®æŒä¹…åŒ–**ï¼šå¦‚éœ€æŒä¹…åŒ–ï¼Œå»ºè®®ä½¿ç”¨æ›´ç¨³å®šçš„æ–¹æ¡ˆ

## ğŸ‰ æ€»ç»“

é€šè¿‡ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œæˆ‘ä»¬å®Œå…¨é¿å…äº† Kryo åºåˆ—åŒ–é—®é¢˜ï¼Œæµ‹è¯•ç°åœ¨åº”è¯¥å¯ä»¥æ­£å¸¸è¿è¡Œã€‚è¿™æ˜¯ä¸€ä¸ªå¿«é€Ÿæœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆï¼Œé€‚åˆå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒä½¿ç”¨ã€‚
