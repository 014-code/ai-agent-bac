# 智能文档检索器使用说明

## 概述

智能文档检索器支持根据AI解析到的用户状态来动态筛选相关文档，提供更精准的恋爱建议。

## 功能特性

### 1. 基础状态过滤检索器
```java
// 根据指定状态筛选文档
Advisor advisor = LoveAppRagCustomAdvisorFactory.createLoveAppRagCustomAdvisor(
    vectorStore, "单身"  // 状态：单身、恋爱中、已婚、离异等
);
```

### 2. 智能状态识别检索器 ⭐
```java
// AI自动分析用户状态并筛选相关文档
Advisor advisor = LoveAppRagCustomAdvisorFactory.createSmartStatusRagAdvisor(
    vectorStore, chatModel
);

// 在LoveApp中使用
String answer = loveApp.doChatWithSmartRag("我今年25岁，单身，不知道怎么追女生", chatId);
```

**特点：**
- 自动分析用户消息中的恋爱状态关键词
- 支持状态：单身、恋爱中、已婚、离异、复合等
- 无需手动指定状态，AI自动识别

### 3. 多状态组合检索器
```java
// 同时查询多个状态的文档
List<String> statusList = Arrays.asList("单身", "恋爱中");
Advisor advisor = LoveAppRagCustomAdvisorFactory.createMultiStatusRagAdvisor(
    vectorStore, statusList
);

// 在LoveApp中使用
String answer = loveApp.doChatWithMultiStatusRag("我想了解恋爱技巧", chatId, statusList);
```

### 4. 年龄+状态组合检索器
```java
// 根据年龄范围和状态精确筛选
Advisor advisor = LoveAppRagCustomAdvisorFactory.createAgeStatusRagAdvisor(
    vectorStore, "已婚", 25, 35  // 状态：已婚，年龄：25-35岁
);

// 在LoveApp中使用
String answer = loveApp.doChatWithAgeStatusRag("我和老公结婚3年了，最近总是吵架", chatId, "已婚", 25, 35);
```

## 使用示例

### 在LoveApp中的完整使用

```java
@Component
public class LoveApp {
    
    // 1. 智能状态识别对话 - 推荐使用
    public String doChatWithSmartRag(String message, String chatId) {
        // AI会自动分析用户状态并筛选相关文档
        return client.prompt()
            .user(message)
            .advisors(LoveAppRagCustomAdvisorFactory.createSmartStatusRagAdvisor(
                loveAppVectorStore, dashscopeChatModel))
            .call()
            .content();
    }
    
    // 2. 多状态组合对话
    public String doChatWithMultiStatusRag(String message, String chatId, List<String> statusList) {
        return client.prompt()
            .user(message)
            .advisors(LoveAppRagCustomAdvisorFactory.createMultiStatusRagAdvisor(
                loveAppVectorStore, statusList))
            .call()
            .content();
    }
    
    // 3. 年龄+状态组合对话
    public String doChatWithAgeStatusRag(String message, String chatId, String status, int minAge, int maxAge) {
        return client.prompt()
            .user(message)
            .advisors(LoveAppRagCustomAdvisorFactory.createAgeStatusRagAdvisor(
                loveAppVectorStore, status, minAge, maxAge))
            .call()
            .content();
    }
}
```

### 测试用例

```java
@Test
void testSmartStatusRag() {
    String chatId = UUID.randomUUID().toString();
    
    // 测试智能状态识别
    String message1 = "我今年25岁，单身，不知道怎么追女生";
    String answer1 = loveApp.doChatWithSmartRag(message1, chatId);
    // AI会自动识别为"单身"状态，并筛选相关文档
    
    // 测试多状态组合查询
    List<String> statusList = Arrays.asList("单身", "恋爱中");
    String message2 = "我想了解恋爱技巧";
    String answer2 = loveApp.doChatWithMultiStatusRag(message2, chatId, statusList);
    // 会同时查询单身和恋爱中状态的文档
    
    // 测试年龄+状态组合查询
    String message3 = "我和老公结婚3年了，最近总是吵架";
    String answer3 = loveApp.doChatWithAgeStatusRag(message3, chatId, "已婚", 25, 35);
    // 会筛选已婚状态且适合25-35岁年龄段的文档
}
```

## 状态关键词识别

智能状态识别检索器支持以下关键词：

| 状态 | 关键词 |
|------|--------|
| 单身 | "单身"、"没有对象"、"单身狗" |
| 恋爱中 | "恋爱"、"男朋友"、"女朋友"、"对象" |
| 已婚 | "已婚"、"老公"、"老婆"、"丈夫"、"妻子" |
| 离异 | "离异"、"离婚"、"分手" |

## 配置参数

### 相似度阈值
- `similarityThreshold`: 文档相似度阈值（0.0-1.0）
- 默认值：0.6（60%相似度）

### 召回数量
- `topK`: 最多返回的文档数量
- 默认值：4-5个文档

### 过滤条件
- 支持状态、年龄、类型等多维度过滤
- 支持组合条件查询

## 最佳实践

1. **推荐使用智能状态识别**：让AI自动分析用户状态，减少手动配置
2. **合理设置相似度阈值**：过高可能召回文档过少，过低可能召回不相关文档
3. **根据业务需求选择检索器**：
   - 简单场景：基础状态过滤
   - 复杂场景：智能状态识别
   - 多维度查询：年龄+状态组合

## 注意事项

1. 确保向量数据库中的文档包含正确的状态和年龄元数据
2. 智能状态识别依赖AI模型，可能偶尔识别错误
3. 建议在关键业务场景中结合多种检索器使用
